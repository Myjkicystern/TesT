<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –º–∏–π–æ–∫ —Ü–∏—Å—Ç–µ—Ä–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body { height:100%; margin:0; font-family:sans-serif; }
#map { height:100%; width:100%; }

#layerBtn, #adminBtn, #locateBtn {
  position:fixed; bottom:15px;
  background:#007bff; color:#fff; border:none;
  padding:10px 15px; border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  cursor:pointer; z-index:4000;
  font-size:18px;
}
#layerBtn { left:15px; }
#adminBtn { right:15px; background:#28a745; width:50px; height:50px; border-radius:50%; font-size:24px; }
#locateBtn { right:15px; bottom:80px; background:#17a2b8; width:50px; height:50px; border-radius:50%; font-size:24px; }

.popup-box {
  background:#fff; padding:20px; border-radius:8px;
  text-align:center; width:280px;
}
.popup-box input, .popup-box textarea {
  width:100%; padding:8px; margin-top:8px;
  border:1px solid #ccc; border-radius:5px;
  font-size:14px;
}
.popup-box button {
  margin-top:10px; padding:8px 15px; background:#007bff;
  border:none; border-radius:5px; color:#fff; cursor:pointer;
}
.popup-box button:hover { background:#0056b3; }
.popup-box .cancel { background:#dc3545; }

.map-counter {
  background:rgba(255,255,255,0.8);
  padding:5px 10px;
  border-radius:8px;
  margin:10px;
}

/* –í—ñ–∫–Ω–∞ */
#loginBox, #addMarkerBox, #editMarkerBox {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); display:flex;
  align-items:center; justify-content:center;
  z-index:5000; display:none;
}

/* –í—ñ–∫–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω–∞) */
#coordSearch {
  display:none;
  position:fixed;
  top:10px; left:50%; transform:translateX(-50%);
  background:rgba(255,255,255,0.9);
  padding:8px 12px; border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  z-index:4000;
}
#coordSearch input {
  width:90px; padding:6px; margin:0 5px;
  border:1px solid #ccc; border-radius:6px;
  font-size:14px;
}
#coordSearch button {
  padding:6px 10px; border:none;
  background:#007bff; color:#fff; border-radius:6px;
  font-size:14px; cursor:pointer;
}
#coordSearch button:hover { background:#0056b3; }

/* –ê–≤—Ç–æ—Ä */
#author {
  position: fixed;
  bottom: 5px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.85);
  color: #333;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 10px;
  z-index: 4000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<div id="map"></div>
<button id="layerBtn">üó∫Ô∏è</button>
<button id="adminBtn">üîë</button>
<button id="locateBtn">üìç</button>

<!-- –ê–≤—Ç–æ—Ä -->
<div id="author">¬© 2025 –ê–≤—Ç–æ—Ä: –ê–Ω–¥—Ä—ñ–π –ú–æ—á—É—Ä–∞–¥</div>

<!-- –í—Ö—ñ–¥ -->
<div id="loginBox">
  <div class="popup-box">
    <h3>–í—Ö—ñ–¥ –¥–ª—è –∞–¥–º—ñ–Ω–∞</h3>
    <input type="password" id="adminPass" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
    <button id="loginSubmit">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginMsg" style="color:red; font-size:14px;"></p>
  </div>
</div>

<!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ -->
<div id="addMarkerBox">
  <div class="popup-box">
    <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="markerTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="markerDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="markerIcon" accept="image/*">
    <button id="addMarkerConfirm">–î–æ–¥–∞—Ç–∏</button>
    <button class="cancel" id="addMarkerCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ -->
<div id="editMarkerBox">
  <div class="popup-box">
    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="editTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="editDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="editIcon" accept="image/*">
    <button id="editSave">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="cancel" id="editCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    <button style="background:#6c757d;" id="editDelete">–í–∏–¥–∞–ª–∏—Ç–∏</button>
  </div>
</div>

<!-- –í—ñ–∫–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω–∞) -->
<div id="coordSearch">
  <input type="number" id="latInput" step="0.0001" placeholder="–®–∏—Ä–æ—Ç–∞">
  <input type="number" id="lngInput" step="0.0001" placeholder="–î–æ–≤–≥–æ—Ç–∞">
  <button id="goToCoord">–ü–µ—Ä–µ–π—Ç–∏</button>
</div>

<script>
// === Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyAUUgaIIozN86glDv5jgT2zhH5Ob1vOt6Y",
  authDomain: "my-map-project-5c821.firebaseapp.com",
  databaseURL: "https://my-map-project-5c821-default-rtdb.firebaseio.com",
  projectId: "my-map-project-5c821",
  storageBucket: "my-map-project-5c821.firebasestorage.app",
  messagingSenderId: "848379078205",
  appId: "1:848379078205:web:e4e796dfc4e9c11f42ec54",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === –ö–∞—Ä—Ç–∞ ===
const map = L.map('map').setView([49,31],6);
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']});
let isSatellite=false;
document.getElementById('layerBtn').onclick=()=>{
  if(isSatellite){ map.removeLayer(satelliteLayer); map.addLayer(osmLayer); document.getElementById('layerBtn').textContent="üó∫Ô∏è"; }
  else { map.removeLayer(osmLayer); map.addLayer(satelliteLayer); document.getElementById('layerBtn').textContent="üåç"; }
  isSatellite=!isSatellite;
};

// === –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ===
document.getElementById('locateBtn').onclick=()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const {latitude, longitude} = pos.coords;
        map.setView([latitude, longitude], 15);
        if(window.userMarker){
          window.userMarker.setLatLng([latitude,longitude]);
        } else {
          window.userMarker = L.circleMarker([latitude,longitude],{
            radius:8, color:'#fff', fillColor:'#3399ff', fillOpacity:0.8
          }).addTo(map).bindPopup("–ú–æ—î –º—ñ—Å—Ü–µ").openPopup();
        }
      },
      err=>alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è."),
      {enableHighAccuracy:true}
    );
  } else alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
};

// === –õ—ñ—á–∏–ª—å–Ω–∏–∫ –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤ ===
const mapViewsRef=db.ref('mapViews');
mapViewsRef.transaction(c=>(c||0)+1);
const counterDiv=L.control({position:'topright'});
counterDiv.onAdd=function(){ this._div=L.DomUtil.create('div','map-counter'); this.update(0); return this._div; };
counterDiv.update=function(val){ this._div.innerHTML=`üëÅÔ∏è ${val}`; };
counterDiv.addTo(map);
mapViewsRef.on('value',snap=>counterDiv.update(snap.val()||0));

// === –ú–∞—Ä–∫–µ—Ä–∏ ===
const markers={};
function addMarkerToMap(id,data){
  const icon = data.icon ? L.icon({iconUrl: data.icon, iconSize:[35,35], iconAnchor:[20,40]}) : undefined;
  const popupContent = `<div style="text-align:center;"><b style="color:#007bff;">${data.title}</b><br>${data.desc}</div>`;
  const marker = L.marker([data.lat,data.lng], icon ? {icon} : {}).addTo(map).bindPopup(popupContent);
  markers[id] = marker;
  if(isAdmin){ marker.on('click', ()=>openEditWindow(id,data)); }
}

// –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏ –Ω–∞ –≤—Å—ñ —Ç–æ—á–∫–∏
function fitMapToMarkers(){
  const allMarkers = Object.values(markers).map(m=>m.getLatLng());
  if(allMarkers.length>0){
    const bounds = L.latLngBounds(allMarkers);
    map.fitBounds(bounds, {padding:[50,50]});
  }
}

// –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤ –¥–ª—è –∞–¥–º—ñ–Ω–∞
function refreshAdminClicks(){
  for(const [id, marker] of Object.entries(markers)){
    marker.off('click');
    if(isAdmin){
      db.ref('markers/'+id).once('value').then(snap=>{
        const data=snap.val();
        marker.on('click', ()=>openEditWindow(id,data));
      });
    }
  }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ –∑ Firebase
db.ref('markers').once('value').then(snap=>{
  snap.forEach(childSnap=>addMarkerToMap(childSnap.key, childSnap.val()));
  fitMapToMarkers();
});
db.ref('markers').on('child_added',snap=>{
  if(!markers[snap.key]) addMarkerToMap(snap.key,snap.val());
  fitMapToMarkers();
});
db.ref('markers').on('child_changed',snap=>{
  if(markers[snap.key]) map.removeLayer(markers[snap.key]);
  addMarkerToMap(snap.key,snap.val());
  fitMapToMarkers();
});
db.ref('markers').on('child_removed',snap=>{
  if(markers[snap.key]){ map.removeLayer(markers[snap.key]); delete markers[snap.key]; }
  fitMapToMarkers();
});

// === –ê–¥–º—ñ–Ω ===
let isAdmin=false;
const ADMIN_PASSWORD="12345";
document.getElementById('adminBtn').onclick=()=>{
  if(isAdmin){
    isAdmin=false;
    refreshAdminClicks();
    map.off('dblclick');
    document.getElementById('adminBtn').textContent="üîë";
    document.getElementById('coordSearch').style.display='none';
    alert("üö™ –í–∏ –≤–∏–π—à–ª–∏ –∑ —Ä–µ–∂–∏–º—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
  } else document.getElementById('loginBox').style.display='flex';
};

document.getElementById('loginSubmit').onclick=()=>{
  const pass=document.getElementById('adminPass').value.trim();
  const loginBox=document.getElementById('loginBox');
  const loginMsg=document.getElementById('loginMsg');

  if(pass===ADMIN_PASSWORD){
    isAdmin=true;
    loginBox.style.display='none';
    document.getElementById('adminBtn').textContent="üö™";
    enableAdminFunctions();
    refreshAdminClicks();
    document.getElementById('coordSearch').style.display='flex'; 
  } else {
    loginMsg.style.color='red';
    loginMsg.innerText="‚ùå –í–∏ –Ω–µ –∞–¥–º—ñ–Ω";
    setTimeout(()=>{
      loginMsg.innerText="";
      loginBox.style.display='none';
      isAdmin=false;
      refreshAdminClicks();
    },3000);
  }
};

// === –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ ===
let pendingLatLng=null;
function enableAdminFunctions(){
  map.on('dblclick', e=>{
    pendingLatLng=e.latlng;
    document.getElementById('addMarkerBox').style.display='flex';
  });
}

document.getElementById('addMarkerCancel').onclick=()=>{
  document.getElementById('addMarkerBox').style.display='none';
  pendingLatLng=null;
};

document.getElementById('addMarkerConfirm').onclick=()=>{
  const title=document.getElementById('markerTitle').value.trim();
  const desc=document.getElementById('markerDesc').value.trim();
  const file=document.getElementById('markerIcon').files[0];
  if(!pendingLatLng || !title || !desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!"); return; }

  const newData = {lat:pendingLatLng.lat, lng:pendingLatLng.lng, title, desc};

  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      newData.icon=e.target.result;
      addMarkerToMap('temp-'+Date.now(), newData);
      db.ref('markers').push(newData);
    };
    reader.readAsDataURL(file);
  } else {
    addMarkerToMap('temp-'+Date.now(), newData);
    db.ref('markers').push(newData);
  }

  document.getElementById('addMarkerBox').style.display='none';
  document.getElementById('markerTitle').value="";
  document.getElementById('markerDesc').value="";
  document.getElementById('markerIcon').value="";
  pendingLatLng=null;
};

// === –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ ===
let currentEditId=null;
function openEditWindow(id,data){
  currentEditId=id;
  document.getElementById('editTitle').value=data.title;
  document.getElementById('editDesc').value=data.desc;
  document.getElementById('editMarkerBox').style.display='flex';
}
document.getElementById('editCancel').onclick=()=>{document.getElementById('editMarkerBox').style.display='none';currentEditId=null;};
document.getElementById('editDelete').onclick=()=>{
  if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç–æ—á–∫—É?")){
    db.ref('markers/'+currentEditId).remove();
    document.getElementById('editMarkerBox').style.display='none';
  }
};
document.getElementById('editSave').onclick=()=>{
  const title=document.getElementById('editTitle').value.trim();
  const desc=document.getElementById('editDesc').value.trim();
  const file=document.getElementById('editIcon').files[0];
  if(!title||!desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!"); return; }

  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      db.ref('markers/'+currentEditId).update({title,desc,icon:e.target.result});
      document.getElementById('editMarkerBox').style.display='none';
    };
    reader.readAsDataURL(file);
  } else {
    db.ref('markers/'+currentEditId).update({title,desc});
    document.getElementById('editMarkerBox').style.display='none';
  }
};

// === –ü–æ—à—É–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω–∞) ===
document.getElementById('goToCoord').onclick=()=>{
  const lat=parseFloat(document.getElementById('latInput').value);
  const lng=parseFloat(document.getElementById('lngInput').value);
  if(isNaN(lat)||isNaN(lng)){ alert("–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏!"); return; }

  map.setView([lat,lng],15);

  let found=false;
  for(const [id, marker] of Object.entries(markers)){
    const pos = marker.getLatLng();
    if(Math.abs(pos.lat-lat)<0.0001 && Math.abs(pos.lng-lng)<0.0001){
      marker.openPopup();
      found=true;
      break;
    }
  }
  if(!found){
    L.marker([lat,lng]).addTo(map)
      .bindPopup(`üìç ${lat.toFixed(4)}, ${lng.toFixed(4)}`)
      .openPopup();
  }
};
</script>
</body>
</html>
