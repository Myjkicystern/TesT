<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="my-icon.png">
<title>–ö–∞—Ä—Ç–∞ –º–∏–π–æ–∫ —Ü–∏—Å—Ç–µ—Ä–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase (compat –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* Loader */
#loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.6); backdrop-filter: blur(3px); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; font-family:sans-serif; font-size:18px; color:#007bff; transition: opacity 0.4s ease, visibility 0.4s ease; }
.loader-spinner { width:60px; height:60px; border:6px solid rgba(0,123,255,0.2); border-top-color:#007bff; border-radius:50%; animation: spin 1s linear infinite; margin-bottom:15px; }
@keyframes spin { to { transform: rotate(360deg); } }
.hidden-loader { opacity:0; visibility:hidden; pointer-events:none; }

/* Map & controls */
html, body { height:100%; margin:0; font-family:sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
#map { height:100%; width:100%; }
#layerBtn, #adminBtn, #locateBtn { position: fixed; border:none; cursor:pointer; z-index:4000; font-size:18px; box-shadow:0 2px 6px rgba(0,0,0,0.25); transition:transform .12s ease; }
#layerBtn { bottom:15px; left:15px; padding:10px 15px; border-radius:8px; background:#007bff; color:#fff; }
#layerBtn:active { transform:scale(.98); }
#adminBtn { bottom:15px; right:15px; width:50px; height:50px; border-radius:50%; background:#28a745; color:#fff; font-size:22px; display:flex; align-items:center; justify-content:center; }
#locateBtn { bottom:80px; right:15px; width:50px; height:50px; border-radius:50%; background:#17a2b8; display:flex; align-items:center; justify-content:center; }
#locateBtn:hover { transform:scale(1.04); }

.popup-box { background:#fff; padding:20px; border-radius:8px; text-align:center; width:320px; max-width:90vw; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.popup-box input, .popup-box textarea { width:100%; padding:8px; margin-top:8px; border:1px solid #ccc; border-radius:5px; font-size:14px; box-sizing:border-box; }
.popup-box button { margin-top:10px; padding:8px 15px; background:#007bff; border:none; border-radius:5px; color:#fff; cursor:pointer; }
.popup-box button:hover { background:#0056b3; }
.popup-box .cancel { background:#dc3545; }

.map-counter { background:rgba(255,255,255,0.95); padding:6px 12px; border-radius:10px; margin:10px; font-size:13px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
#loginBox, #addMarkerBox, #editMarkerBox { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:5000; display:none; }
#coordSearch { display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.95); padding:8px 12px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12); z-index:4000; }
#coordSearch input { width:110px; padding:6px; margin:0 5px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
#coordSearch button { padding:6px 10px; border:none; background:#007bff; color:#fff; border-radius:6px; font-size:14px; cursor:pointer; }
#author { position: fixed; bottom: 5px; left:50%; transform:translateX(-50%); background: rgba(255,255,255,0.9); color:#333; padding:4px 10px; border-radius:8px; font-size:11px; z-index:4000; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

/* Popup marker inner styles (for mobile-friendly buttons) */
.marker-popup { text-align:center; font-size:14px; max-width:260px; }
.marker-title { color:#007bff; font-weight:600; margin-bottom:6px; }
.marker-desc { margin-bottom:8px; color:#333; white-space:normal; word-break:break-word; }

/* Buttons inside popup */
.popup-btns { display:flex; justify-content:space-around; gap:8px; flex-wrap:wrap; }
.popup-icon-btn {
  -webkit-tap-highlight-color: transparent;
  display:flex; align-items:center; justify-content:center;
  width:56px; height:56px; border-radius:12px; border:none; cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.85));
}
.popup-icon-btn svg { width:28px; height:28px; }
.popup-icon-btn:active { transform:translateY(1px) scale(.995); }

/* Responsive */
@media (max-width:420px){
  .popup-icon-btn { width:52px; height:52px; border-radius:10px; }
  .popup-btns { gap:6px; }
  .popup-box { padding:14px; width:300px; }
}
</style>
</head>
<body>

<div id="loader">
  <div class="loader-spinner"></div>
  <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ—á–æ–∫...</div>
</div>

<div id="map"></div>
<button id="layerBtn" aria-label="–ó–º—ñ–Ω–∏—Ç–∏ —à–∞—Ä">üó∫Ô∏è</button>
<button id="adminBtn" aria-label="–†–µ–∂–∏–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è">üîë</button>
<button id="locateBtn" title="–ú–æ—î –º—ñ—Å—Ü–µ" aria-label="–ú–æ—è –ª–æ–∫–∞—Ü—ñ—è">üìç</button>
<div id="author">¬© 2025 –ê–≤—Ç–æ—Ä: –ê–Ω–¥—Ä—ñ–π –ú–æ—á—É—Ä–∞–¥</div>

<!-- Login -->
<div id="loginBox">
  <div class="popup-box">
    <h3>–í—Ö—ñ–¥ –¥–ª—è –∞–¥–º—ñ–Ω–∞</h3>
    <input type="password" id="adminPass" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
    <button id="loginSubmit">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginMsg" style="color:red; font-size:14px; margin-top:8px;"></p>
  </div>
</div>

<!-- Add marker -->
<div id="addMarkerBox">
  <div class="popup-box">
    <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="markerTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="markerDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="markerIcon" accept="image/*">
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button id="addMarkerConfirm">–î–æ–¥–∞—Ç–∏</button>
      <button class="cancel" id="addMarkerCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<!-- Edit marker -->
<div id="editMarkerBox">
  <div class="popup-box">
    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="editTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="editDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="editIcon" accept="image/*">
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button id="editSave">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="cancel" id="editCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button id="editDelete" style="background:#6c757d; color:#fff;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
    </div>
  </div>
</div>

<!-- Coordinates search -->
<div id="coordSearch">
  <input type="number" id="latInput" step="0.0001" placeholder="–®–∏—Ä–æ—Ç–∞">
  <input type="number" id="lngInput" step="0.0001" placeholder="–î–æ–≤–≥–æ—Ç–∞">
  <button id="goToCoord">–ü–µ—Ä–µ–π—Ç–∏</button>
</div>

<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAUUgaIIozN86glDv5jgT2zhH5Ob1vOt6Y",
  authDomain: "my-map-project-5c821.firebaseapp.com",
  databaseURL: "https://my-map-project-5c821-default-rtdb.firebaseio.com",
  projectId: "my-map-project-5c821",
  storageBucket: "my-map-project-5c821.firebasestorage.app",
  messagingSenderId: "848379078205",
  appId: "1:848379078205:web:e4e796dfc4e9c11f42ec54",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- Map & layers ----------------
const map = L.map('map').setView([49,31],6);
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']});
let isSatellite=false;
document.getElementById('layerBtn').onclick = () => {
  if(isSatellite){ map.removeLayer(satelliteLayer); map.addLayer(osmLayer); document.getElementById('layerBtn').textContent="üó∫Ô∏è"; }
  else { map.removeLayer(osmLayer); map.addLayer(satelliteLayer); document.getElementById('layerBtn').textContent="üåç"; }
  isSatellite = !isSatellite;
};

// ---------------- Geolocation (locate button) ----------------
document.getElementById('locateBtn').onclick = () => {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 15);
      if(window.userMarker) window.userMarker.setLatLng([latitude,longitude]);
      else window.userMarker = L.circleMarker([latitude,longitude],{radius:8,color:'#fff',fillColor:'#3399ff',fillOpacity:0.85}).addTo(map).bindPopup("–ú–æ—î –º—ñ—Å—Ü–µ");
      if(window.userMarker && window.userMarker.getPopup) window.userMarker.openPopup();
    }, ()=>alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è."), {enableHighAccuracy:true});
  } else alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
};

// ---------------- Counters ----------------
const mapViewsRef = db.ref('mapViews');
const markersRef = db.ref('markers');
mapViewsRef.transaction(c => (c||0)+1);

const counterDiv = L.control({position:'topright'});
counterDiv.onAdd = function(){
  this._div = L.DomUtil.create('div','map-counter');
  this.update(0,0);
  return this._div;
};
counterDiv.update = function(views, count){
  this._div.innerHTML = `üëÅÔ∏è ${views}  &nbsp; | &nbsp; üìå ${count}`;
};
counterDiv.addTo(map);

let markerCount = 0;
mapViewsRef.on('value', snap => counterDiv.update(snap.val()||0, markerCount));
markersRef.on('value', snap => {
  markerCount = snap.numChildren();
  mapViewsRef.once('value').then(vsnap => counterDiv.update(vsnap.val()||0, markerCount));
});

// ---------------- Markers storage ----------------
const markers = {}; // id -> leaflet marker

// Helper: create responsive popup DOM for a marker
function createMarkerPopupDOM(data) {
  const container = document.createElement('div');
  container.className = 'marker-popup';

  const title = document.createElement('div');
  title.className = 'marker-title';
  title.textContent = data.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
  container.appendChild(title);

  const desc = document.createElement('div');
  desc.className = 'marker-desc';
  desc.textContent = data.desc || '';
  container.appendChild(desc);

  // Buttons container
  const btns = document.createElement('div');
  btns.className = 'popup-btns';

  // Route button (from user's current location to this marker)
  const routeBtn = document.createElement('button');
  routeBtn.className = 'popup-icon-btn';
  routeBtn.title = '–ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ —Ü—ñ—î—ó —Ç–æ—á–∫–∏';
  routeBtn.setAttribute('aria-label', '–ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç');

  routeBtn.innerHTML = `
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#34A853">
      <path d="M21 3L11 13H14V21L21 3Z"/>
    </svg>
  `;
  btns.appendChild(routeBtn);

  // Share button
  const shareBtn = document.createElement('button');
  shareBtn.className = 'popup-icon-btn';
  shareBtn.title = '–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è';
  shareBtn.setAttribute('aria-label', '–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è');

  shareBtn.innerHTML = `
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#25D366">
      <path d="M18 16.08C17.24 16.08 16.56 16.38 16.05 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12C9 11.76 8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5C21 3.34 19.66 2 18 2C16.34 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12C3 13.66 4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.14 18.34C15.09 18.57 15.05 18.8 15.05 19C15.05 20.66 16.39 22 18.05 22C19.71 22 21.05 20.66 21.05 19C21.05 17.34 19.71 16 18.05 16H18Z"/>
    </svg>
  `;
  btns.appendChild(shareBtn);

  container.appendChild(btns);

  // Return both DOM and button references to attach handlers later
  return {container, routeBtn, shareBtn};
}

// Create and add marker (ensures handlers are bound to each marker instance)
function addMarkerToMap(id, data) {
  // Remove existing if present (safe)
  if(markers[id]) {
    try { map.removeLayer(markers[id]); } catch(e) {}
    delete markers[id];
  }

  const icon = data.icon ? L.icon({ iconUrl: data.icon, iconSize: [36,36], iconAnchor:[18,36] }) : undefined;
  const {container, routeBtn, shareBtn} = createMarkerPopupDOM(data);

  const marker = L.marker([data.lat, data.lng], icon ? {icon} : {}).addTo(map);
  marker.bindPopup(container, {maxWidth: 320});
  marker.options.data = data;
  markers[id] = marker;

  // Route handler ‚Äî always ask for user's current position, then open Google Maps directions
  routeBtn.onclick = () => {
    if(!navigator.geolocation) {
      alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
      return;
    }
    routeBtn.disabled = true;
    navigator.geolocation.getCurrentPosition(pos => {
      routeBtn.disabled = false;
      const {latitude, longitude} = pos.coords;
      // Use lat,lng for destination (works reliably)
      const dest = `${data.lat},${data.lng}`;
      const start = `${latitude},${longitude}`;
      const url = `https://www.google.com/maps/dir/${encodeURIComponent(start)}/${encodeURIComponent(dest)}`;
      window.open(url, "_blank");
    }, err => {
      routeBtn.disabled = false;
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è.");
    }, {enableHighAccuracy: true, timeout: 10000});
  };

  // Share handler
  shareBtn.onclick = async () => {
    const shareText = `üìç ${data.title || '–ú—ñ—Å—Ü–µ'}\n${data.desc || ''}\nhttps://maps.google.com/?q=${encodeURIComponent(data.lat + ',' + data.lng)}`;
    if(navigator.share) {
      try { await navigator.share({text: shareText}); }
      catch(e) { alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥—É."); }
    } else {
      try {
        await navigator.clipboard.writeText(shareText);
        alert("–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.");
      } catch (e) {
        prompt("–°–∫–æ–ø—ñ—é–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É:", shareText);
      }
    }
  };

  // Admin edit open on click if admin mode
  if(isAdmin) marker.on('click', () => openEditWindow(id, marker.options.data));
}

// ensure admin click bindings are fresh for all markers
function refreshAdminClicks(){
  for(const [id, marker] of Object.entries(markers)){
    marker.off('click');
    if(isAdmin) marker.on('click', () => openEditWindow(id, marker.options.data));
  }
}

// ---------------- Firebase listeners ----------------
markersRef.on('child_added', snap => {
  const id = snap.key;
  const data = snap.val();
  if(!markers[id]) addMarkerToMap(id, data);
});

markersRef.on('child_changed', snap => {
  const id = snap.key;
  const data = snap.val();
  // remove old marker if exists then add new
  if(markers[id]) {
    try { map.removeLayer(markers[id]); } catch(e){}
    delete markers[id];
  }
  addMarkerToMap(id, data);
  refreshAdminClicks();
});

markersRef.on('child_removed', snap => {
  const id = snap.key;
  if(markers[id]) {
    try { map.removeLayer(markers[id]); } catch(e){}
    delete markers[id];
  }
});

// Hide loader after initial load
const loader = document.getElementById('loader');
loader.style.display = 'flex';
markersRef.once('value').then(snap => {
  setTimeout(()=> loader.classList.add('hidden-loader'), 250);
});

// Auto-fit bounds on initial load
markersRef.once('value').then(snap=>{
  const data = snap.val();
  if(!data) return;
  const latlngs = [];
  for(const k in data) {
    if(data[k] && typeof data[k].lat === 'number' && typeof data[k].lng === 'number') latlngs.push([data[k].lat, data[k].lng]);
  }
  if(latlngs.length>0) map.fitBounds(latlngs, {padding:[20,20]});
});

// ---------------- Admin (add/edit/delete) ----------------
let isAdmin = false;
const ADMIN_PASSWORD = "12345"; // –∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ

document.getElementById('adminBtn').onclick = () => {
  if(isAdmin){
    isAdmin = false;
    refreshAdminClicks();
    map.off('dblclick');
    document.getElementById('adminBtn').textContent = "üîë";
    document.getElementById('coordSearch').style.display = 'none';
    alert("üö™ –í–∏ –≤–∏–π—à–ª–∏ –∑ —Ä–µ–∂–∏–º—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
  } else {
    document.getElementById('loginBox').style.display = 'flex';
  }
};

document.getElementById('loginSubmit').onclick = () => {
  const pass = document.getElementById('adminPass').value.trim();
  const loginBox = document.getElementById('loginBox');
  const loginMsg = document.getElementById('loginMsg');
  if(pass === ADMIN_PASSWORD){
    isAdmin = true;
    loginBox.style.display = 'none';
    document.getElementById('adminBtn').textContent = "üö™";
    enableAdminFunctions();
    refreshAdminClicks();
    document.getElementById('coordSearch').style.display = 'flex';
  } else {
    loginMsg.style.color = 'red';
    loginMsg.innerText = "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å";
    setTimeout(()=>{ loginMsg.innerText = ""; loginBox.style.display = 'none'; }, 2500);
  }
};

// Enable adding by dblclick
let pendingLatLng = null;
function enableAdminFunctions(){
  map.on('dblclick', e => {
    pendingLatLng = e.latlng;
    document.getElementById('addMarkerBox').style.display = 'flex';
  });
}

// Add marker handlers
document.getElementById('addMarkerCancel').onclick = () => {
  document.getElementById('addMarkerBox').style.display = 'none';
  pendingLatLng = null;
};

document.getElementById('addMarkerConfirm').onclick = () => {
  if(!isAdmin){ alert("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω –º–æ–∂–µ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏."); return; }
  const title = document.getElementById('markerTitle').value.trim();
  const desc = document.getElementById('markerDesc').value.trim();
  const file = document.getElementById('markerIcon').files[0];
  if(!pendingLatLng || !title || !desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ (–ø–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫)."); return; }

  const newData = { lat: pendingLatLng.lat, lng: pendingLatLng.lng, title, desc };

  const pushToFirebase = (data) => {
    const newRef = db.ref('markers').push();
    newRef.set(data);
  };

  if(file){
    const reader = new FileReader();
    reader.onload = e => {
      newData.icon = e.target.result;
      pushToFirebase(newData);
    };
    reader.readAsDataURL(file);
  } else {
    pushToFirebase(newData);
  }

  // clear form
  document.getElementById('addMarkerBox').style.display = 'none';
  document.getElementById('markerTitle').value = "";
  document.getElementById('markerDesc').value = "";
  document.getElementById('markerIcon').value = "";
  pendingLatLng = null;
};

// Edit marker
let currentEditId = null;
function openEditWindow(id, data){
  currentEditId = id;
  document.getElementById('editTitle').value = data.title || '';
  document.getElementById('editDesc').value = data.desc || '';
  document.getElementById('editMarkerBox').style.display = 'flex';
}
document.getElementById('editCancel').onclick = () => {
  document.getElementById('editMarkerBox').style.display = 'none';
  currentEditId = null;
};
document.getElementById('editDelete').onclick = () => {
  if(!currentEditId) return;
  if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç–æ—á–∫—É?")) {
    db.ref('markers/' + currentEditId).remove();
    document.getElementById('editMarkerBox').style.display = 'none';
    currentEditId = null;
  }
};
document.getElementById('editSave').onclick = () => {
  if(!currentEditId) return;
  const title = document.getElementById('editTitle').value.trim();
  const desc = document.getElementById('editDesc').value.trim();
  const file = document.getElementById('editIcon').files[0];
  if(!title || !desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è."); return; }

  const updateMarker = (data) => {
    db.ref('markers/' + currentEditId).update(data);
    document.getElementById('editMarkerBox').style.display = 'none';
    currentEditId = null;
  };

  if(file){
    const reader = new FileReader();
    reader.onload = e => updateMarker({ title, desc, icon: e.target.result });
    reader.readAsDataURL(file);
  } else updateMarker({ title, desc });
};

// ---------------- Coordinate search & temp marker ----------------
let tempAddMarker = null;
document.getElementById('goToCoord').onclick = () => {
  const lat = parseFloat(document.getElementById('latInput').value);
  const lng = parseFloat(document.getElementById('lngInput').value);
  if(isNaN(lat) || isNaN(lng)){ alert("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏."); return; }

  map.setView([lat,lng], 15);

  if(tempAddMarker) tempAddMarker.setLatLng([lat,lng]);
  else tempAddMarker = L.marker([lat,lng], {draggable:true}).addTo(map).bindPopup("–¢–æ—á–∫–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è").openPopup();

  pendingLatLng = { lat, lng };
};

// ---------------- Utility: allow keyboard escape to close modals ----------------
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') {
    ['loginBox','addMarkerBox','editMarkerBox'].forEach(id => {
      const el = document.getElementById(id);
      if(el && el.style.display === 'flex') el.style.display = 'none';
    });
    currentEditId = null;
    pendingLatLng = null;
  }
});

// ---------------- End of script ----------------
</script>
</body>
</html>
