<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –º–∏–π–æ–∫ —Ü–∏—Å—Ç–µ—Ä–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* Loader */
#loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(3px);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  font-family: sans-serif;
  font-size: 18px;
  color: #007bff;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}
.loader-spinner {
  width: 60px;
  height: 60px;
  border: 6px solid rgba(0, 123, 255, 0.2);
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}
#loader-text {
  margin-left: -35px; /* –∑—Å—É–≤–∞—î –ª—ñ–≤—ñ—à–µ */
}
#loader div:last-child {
  text-align: center;
  font-weight: 600;
}

@keyframes spin { to { transform: rotate(360deg); } }
.hidden-loader { opacity:0; visibility:hidden; }

/* Map */
html, body { height:100%; margin:0; font-family:sans-serif; }
#map { height:100%; width:100%; }
#layerBtn, #adminBtn, #locateBtn { position: fixed; border:none; cursor:pointer; z-index:4000; font-size:18px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
#layerBtn { bottom:15px; left:15px; padding:10px 15px; border-radius:8px; background:#007bff; color:#fff; }
#adminBtn { bottom:15px; right:15px; width:50px; height:50px; border-radius:50%; background:#28a745; color:#fff; font-size:24px; display:flex; align-items:center; justify-content:center; }
#locateBtn {
  bottom: 80px;
  right: 15px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #17a2b8;
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  z-index: 4000;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
  overflow: hidden;
}
#locateBtn:hover {
  background: #138496;
  transform: scale(1.1);
}
#locateBtn::before {
  content: '';
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
}

.popup-box { background:#fff; padding:20px; border-radius:8px; text-align:center; width:280px; }
.popup-box input, .popup-box textarea { width:100%; padding:8px; margin-top:8px; border:1px solid #ccc; border-radius:5px; font-size:14px; }
.popup-box button { margin-top:10px; padding:8px 15px; background:#007bff; border:none; border-radius:5px; color:#fff; cursor:pointer; }
.popup-box button:hover { background:#0056b3; }
.popup-box .cancel { background:#dc3545; }

.map-counter { background:rgba(255,255,255,0.8); padding:5px 10px; border-radius:8px; margin:10px; }
#loginBox, #addMarkerBox, #editMarkerBox { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:5000; display:none; }
#coordSearch { display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:4000; }
#coordSearch input { width:90px; padding:6px; margin:0 5px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
#coordSearch button { padding:6px 10px; border:none; background:#007bff; color:#fff; border-radius:6px; font-size:14px; cursor:pointer; }
#coordSearch button:hover { background:#0056b3; }
#author { position: fixed; bottom: 5px; left:50%; transform:translateX(-50%); background: rgba(255,255,255,0.85); color:#333; padding:4px 10px; border-radius:8px; font-size:10px; z-index:4000; box-shadow:0 2px 4px rgba(0,0,0,0.2); }

.share-btn-container {
  display: flex;
  justify-content: center;
  margin-top: 8px;
  flex-wrap: wrap;
  gap: 8px;
}

.share-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 25px;
  font-size: 13px;
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  border: none;
  font-weight: 500;
}

.share-btn svg {
  width: 18px;
  height: 18px;
  fill: white;
}

.share-btn.route {
  background: linear-gradient(135deg, #34a853, #0f9d58);
}
.share-btn.route:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(52,168,83,0.4);
}

.share-btn.share {
  background: linear-gradient(135deg, #25d366, #128c7e);
}
.share-btn.share:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(37,211,102,0.4);
}


#locate-spinner {
  position: absolute;
  width: 22px;
  height: 22px;
  border: 3px solid rgba(255,255,255,0.5);
  border-top-color: #fff;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(0deg);
  pointer-events: none;
  z-index: 1;
  transition: transform 0.3s;
}

/* –∞–∫—Ç–∏–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è */
#locateBtn.active #locate-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

</style>
</head>
<body>

<div id="loader">
  <div class="loader-spinner"></div>
  <div id="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ—á–æ–∫...</div>
</div>




<div id="map"></div>
<button id="layerBtn">üó∫Ô∏è</button>
<button id="adminBtn">üîë</button>
<!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó -->
<button id="locateBtn" title="–ú–æ—î –º—ñ—Å—Ü–µ">
  <div id="locate-spinner"></div>
</button>

<div id="author">¬© 2025 –ê–≤—Ç–æ—Ä: –ê–Ω–¥—Ä—ñ–π –ú–æ—á—É—Ä–∞–¥</div>


<!-- –í—Ö—ñ–¥ -->
<div id="loginBox">
  <div class="popup-box">
    <h3>–í—Ö—ñ–¥ –¥–ª—è –∞–¥–º—ñ–Ω–∞</h3>
    <input type="password" id="adminPass" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
    <button id="loginSubmit">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginMsg" style="color:red; font-size:14px;"></p>
  </div>
</div>

<!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ -->
<div id="addMarkerBox">
  <div class="popup-box">
    <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="markerTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="markerDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="markerIcon" accept="image/*">
    <button id="addMarkerConfirm">–î–æ–¥–∞—Ç–∏</button>
    <button class="cancel" id="addMarkerCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ -->
<div id="editMarkerBox">
  <div class="popup-box">
    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
    <input type="text" id="editTitle" placeholder="–ù–∞–∑–≤–∞">
    <textarea id="editDesc" placeholder="–û–ø–∏—Å"></textarea>
    <input type="file" id="editIcon" accept="image/*">
    <button id="editSave">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="cancel" id="editCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    <button style="background:#6c757d;" id="editDelete">–í–∏–¥–∞–ª–∏—Ç–∏</button>
  </div>
</div>

<!-- –í—ñ–∫–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
<div id="coordSearch">
  <input type="number" id="latInput" step="0.0001" placeholder="–®–∏—Ä–æ—Ç–∞">
  <input type="number" id="lngInput" step="0.0001" placeholder="–î–æ–≤–≥–æ—Ç–∞">
  <button id="goToCoord">–ü–µ—Ä–µ–π—Ç–∏</button>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAUUgaIIozN86glDv5jgT2zhH5Ob1vOt6Y",
  authDomain: "my-map-project-5c821.firebaseapp.com",
  databaseURL: "https://my-map-project-5c821-default-rtdb.firebaseio.com",
  projectId: "my-map-project-5c821",
  storageBucket: "my-map-project-5c821.firebasestorage.app",
  messagingSenderId: "848379078205",
  appId: "1:848379078205:web:e4e796dfc4e9c11f42ec54",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// –ö–∞—Ä—Ç–∞
const map = L.map('map').setView([49,31],6);
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']});
let isSatellite=false;
document.getElementById('layerBtn').onclick=()=>{ 
  if(isSatellite){ map.removeLayer(satelliteLayer); map.addLayer(osmLayer); document.getElementById('layerBtn').textContent="üó∫Ô∏è"; }
  else { map.removeLayer(osmLayer); map.addLayer(satelliteLayer); document.getElementById('layerBtn').textContent="üåç"; }
  isSatellite=!isSatellite;
};

// ----------------- –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é -----------------
document.getElementById('locateBtn').onclick = () => {
  const btn = document.getElementById('locateBtn');
  btn.classList.add('active');

  if (!navigator.geolocation) {
    alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
    btn.classList.remove('active');
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    map.setView([latitude, longitude], 15);
    if (window.userMarker) window.userMarker.setLatLng([latitude, longitude]);
    else window.userMarker = L.circleMarker([latitude, longitude], {
      radius: 8,
      color: '#fff',
      fillColor: '#3399ff',
      fillOpacity: 0.8
    }).addTo(map).bindPopup("–ú–æ—î –º—ñ—Å—Ü–µ").openPopup();

    btn.classList.remove('active');
  }, () => {
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è.");
    btn.classList.remove('active');
  }, { enableHighAccuracy: true });
};



// ----------------- –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ -----------------
const mapViewsRef=db.ref('mapViews');
const markersRef=db.ref('markers');
mapViewsRef.transaction(c=>(c||0)+1);

const counterDiv=L.control({position:'topright'});
counterDiv.onAdd=function(){ 
  this._div=L.DomUtil.create('div','map-counter'); 
  this.update(0,0); 
  return this._div; 
};
counterDiv.update=function(views, count){ 
  this._div.innerHTML=`üëÅÔ∏è ${views} | üìå ${count}`; 
};
counterDiv.addTo(map);

let markerCount = 0;
mapViewsRef.on('value',snap=>counterDiv.update(snap.val()||0, markerCount));
markersRef.on('value',snap=>{
  markerCount = snap.numChildren();
  mapViewsRef.once('value').then(vsnap=>{ counterDiv.update(vsnap.val()||0, markerCount); });
});

// ----------------- –ú–∞—Ä–∫–µ—Ä–∏ -----------------
const markers = {};
let isAdmin=false;
let pendingLatLng=null;
const ADMIN_PASSWORD="12345";

function addMarkerToMap(id, data){
  const icon = data.icon ? L.icon({ iconUrl: data.icon, iconSize: [35,35], iconAnchor:[20,40] }) : undefined;
  
  const popupDiv = document.createElement('div');
  popupDiv.style.textAlign='center';
  popupDiv.innerHTML = `<b style="color:#007bff;">${data.title}</b><br>${data.desc}`;

// –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
const btnContainer = document.createElement('div');
btnContainer.className = 'share-btn-container';

// –ö–Ω–æ–ø–∫–∞ "–ú–∞—Ä—à—Ä—É—Ç"
const routeBtn = document.createElement('button');
routeBtn.className = 'share-btn route';
routeBtn.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.44 9.03L4.56 4.57a.75.75 0 00-.95.95l4.46 14.88a.75.75 0 001.38.13l2.78-5.09 5.09-2.78a.75.75 0 00-.13-1.38z"/></svg>
  –ú–∞—Ä—à—Ä—É—Ç
`;
routeBtn.onclick = async () => {
  if (!window.userMarker) { alert("–°–ø–µ—Ä—à—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ú–æ—î –º—ñ—Å—Ü–µ"); return; }
  const latlng = window.userMarker.getLatLng();
  const url = `https://www.google.com/maps/dir/${latlng.lat},${latlng.lng}/${data.lat},${data.lng}`;
  window.open(url, "_blank");
};
btnContainer.appendChild(routeBtn);

// –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è"
const shareBtn = document.createElement('button');
shareBtn.className = 'share-btn share';
shareBtn.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.48 2.48 0 000-1.39l7.02-4.11A2.5 2.5 0 1014.5 5a2.5 2.5 0 00.04.42L7.53 9.53a2.5 2.5 0 100 4.94l7.01 4.12A2.5 2.5 0 1018 16.08z"/></svg>
  –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è
`;
shareBtn.onclick = async () => {
  const shareText = `üìç ${data.title}\n${data.desc}`;
  if (navigator.share) {
    try { await navigator.share({ text: shareText }); } 
    catch(e) { alert("–ü–æ–º–∏–ª–∫–∞ —à–∞—Ä–∏–Ω–≥—É"); }
  } else {
    navigator.clipboard.writeText(shareText);
    alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ");
  }
};
btnContainer.appendChild(shareBtn);

popupDiv.appendChild(btnContainer);


  const marker = L.marker([data.lat,data.lng], icon?{icon}:{}).addTo(map).bindPopup(popupDiv);
  marker.options.data = data;
  markers[id]=marker;

  if(isAdmin) marker.on('click', ()=>openEditWindow(id, data));
}

function refreshAdminClicks(){ 
  for(const [id, marker] of Object.entries(markers)){ 
    marker.off('click'); 
    if(isAdmin) marker.on('click',()=>openEditWindow(id, marker.options.data)); 
  } 
}

// ----------------- Firebase sync -----------------
markersRef.on('child_added',snap=>{ if(!markers[snap.key]) addMarkerToMap(snap.key,snap.val()); });
markersRef.on('child_changed',snap=>{ if(markers[snap.key]){ map.removeLayer(markers[snap.key]); addMarkerToMap(snap.key,snap.val()); } });
markersRef.on('child_removed',snap=>{ if(markers[snap.key]){ map.removeLayer(markers[snap.key]); delete markers[snap.key]; } });

// Loader
const loader = document.getElementById('loader');
markersRef.once('value').then(snap => { setTimeout(()=>{ loader.classList.add('hidden-loader'); },300); });

// –ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä
markersRef.once('value').then(snap=>{
  const data=snap.val();
  if(!data) return;
  const latlngs=Object.values(data).map(m=>[m.lat,m.lng]);
  if(latlngs.length>0) map.fitBounds(latlngs,{padding:[-50,10]});
});

// ----------------- –ê–¥–º—ñ–Ω -----------------
document.getElementById('adminBtn').onclick=()=>{ 
  if(isAdmin){ 
    isAdmin=false; refreshAdminClicks(); map.off('dblclick'); 
    document.getElementById('adminBtn').textContent="üîë"; 
    document.getElementById('coordSearch').style.display='none'; 
    alert("üö™ –í–∏ –≤–∏–π—à–ª–∏ –∑ —Ä–µ–∂–∏–º—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞."); 
  } else document.getElementById('loginBox').style.display='flex';
};
document.getElementById('loginSubmit').onclick=()=>{ 
  const pass=document.getElementById('adminPass').value.trim(); 
  const loginBox=document.getElementById('loginBox'); 
  const loginMsg=document.getElementById('loginMsg');
  if(pass===ADMIN_PASSWORD){ 
    isAdmin=true; loginBox.style.display='none'; 
    document.getElementById('adminBtn').textContent="üö™"; 
    enableAdminFunctions(); refreshAdminClicks(); 
    document.getElementById('coordSearch').style.display='flex'; 
  } else { 
    loginMsg.style.color='red'; 
    loginMsg.innerText="‚ùå –í–∏ –Ω–µ –∞–¥–º—ñ–Ω"; 
    setTimeout(()=>{ loginMsg.innerText=""; loginBox.style.display='none'; isAdmin=false; refreshAdminClicks(); },3000); 
  }
};

// ----------------- –î–æ–¥–∞–≤–∞–Ω–Ω—è -----------------
function enableAdminFunctions(){ 
  map.on('dblclick', e=>{ 
    pendingLatLng=e.latlng; 
    document.getElementById('addMarkerBox').style.display='flex'; 
  }); 
}
document.getElementById('addMarkerCancel').onclick=()=>{ document.getElementById('addMarkerBox').style.display='none'; pendingLatLng=null; };
document.getElementById('addMarkerConfirm').onclick=()=>{
  if(!isAdmin){ alert("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω –º–æ–∂–µ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏!"); return; }
  const title=document.getElementById('markerTitle').value.trim();
  const desc=document.getElementById('markerDesc').value.trim();
  const file=document.getElementById('markerIcon').files[0];
  if(!pendingLatLng||!title||!desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!"); return; }

  const newData={lat: pendingLatLng.lat, lng: pendingLatLng.lng, title, desc};
  const pushToFirebase=(data)=>{ db.ref('markers').push().set(data); }

  if(file){
    const reader=new FileReader();
    reader.onload=e=>{ newData.icon=e.target.result; pushToFirebase(newData); };
    reader.readAsDataURL(file);
  } else { pushToFirebase(newData); }

  document.getElementById('addMarkerBox').style.display='none';
  document.getElementById('markerTitle').value="";
  document.getElementById('markerDesc').value="";
  document.getElementById('markerIcon').value="";
  pendingLatLng=null;
};

// ----------------- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è -----------------
let currentEditId=null;
function openEditWindow(id,data){ 
  currentEditId=id; 
  document.getElementById('editTitle').value=data.title; 
  document.getElementById('editDesc').value=data.desc; 
  document.getElementById('editMarkerBox').style.display='flex'; 
}
document.getElementById('editCancel').onclick=()=>{document.getElementById('editMarkerBox').style.display='none';currentEditId=null;};
document.getElementById('editDelete').onclick=()=>{ 
  if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç–æ—á–∫—É?")){ 
    db.ref('markers/'+currentEditId).remove(); 
    document.getElementById('editMarkerBox').style.display='none'; 
  } 
};
document.getElementById('editSave').onclick=()=>{ 
  const title=document.getElementById('editTitle').value.trim(); 
  const desc=document.getElementById('editDesc').value.trim(); 
  const file=document.getElementById('editIcon').files[0];
  if(!title||!desc){ alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!"); return; }

  const updateMarker = (data)=>{ db.ref('markers/'+currentEditId).update(data); document.getElementById('editMarkerBox').style.display='none'; }

  if(file){
    const reader=new FileReader();
    reader.onload=e=>{ updateMarker({title, desc, icon:e.target.result}); };
    reader.readAsDataURL(file);
  } else { updateMarker({title, desc}); }
};

// ----------------- –ü–æ—à—É–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö -----------------
let tempAddMarker = null;
document.getElementById('goToCoord').onclick = () => { 
  const lat = parseFloat(document.getElementById('latInput').value); 
  const lng = parseFloat(document.getElementById('lngInput').value);
  if (isNaN(lat) || isNaN(lng)) { alert("–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏!"); return; }

  map.setView([lat,lng], 15);
  if(tempAddMarker) tempAddMarker.setLatLng([lat,lng]);
  else tempAddMarker = L.marker([lat,lng], {draggable:true}).addTo(map).bindPopup("–¢–æ—á–∫–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è").openPopup();
  pendingLatLng = {lat, lng};
};
</script>
</body>
</html>
